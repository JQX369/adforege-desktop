{"version":3,"sources":["../../../src/server/async-storage/with-request-store.ts"],"sourcesContent":["import type { BaseNextRequest, BaseNextResponse } from '../base-http'\nimport type { IncomingHttpHeaders, IncomingMessage, ServerResponse } from 'http'\nimport type { AsyncLocalStorage } from 'async_hooks'\nimport type { RequestStore } from '../../client/components/request-async-storage.external'\nimport type { RenderOpts } from '../app-render/types'\nimport type { WithStore } from './with-store'\nimport type { NextRequest } from '../web/spec-extension/request'\nimport type { __ApiPreviewProps } from '../api-utils'\n\nimport { FLIGHT_PARAMETERS } from '../../client/components/app-router-headers'\nimport {\n  HeadersAdapter,\n  type ReadonlyHeaders,\n} from '../web/spec-extension/adapters/headers'\nimport {\n  MutableRequestCookiesAdapter,\n  RequestCookiesAdapter,\n  type ReadonlyRequestCookies,\n} from '../web/spec-extension/adapters/request-cookies'\nimport { ResponseCookies, RequestCookies } from '../web/spec-extension/cookies'\nimport { DraftModeProvider } from './draft-mode-provider'\nimport { splitCookiesString } from '../web/utils'\nimport { createAfterContext, type AfterContext } from '../after/after-context'\nimport type { RequestLifecycleOpts } from '../base-server'\n\nfunction getHeaders(headers: Headers | IncomingHttpHeaders): ReadonlyHeaders {\n  const cleaned = HeadersAdapter.from(headers)\n  for (const param of FLIGHT_PARAMETERS) {\n    cleaned.delete(param.toString().toLowerCase())\n  }\n\n  return HeadersAdapter.seal(cleaned)\n}\n\nfunction getMutableCookies(\n  headers: Headers | IncomingHttpHeaders,\n  onUpdateCookies?: (cookies: string[]) => void\n): ResponseCookies {\n  const cookies = new RequestCookies(HeadersAdapter.from(headers))\n  return MutableRequestCookiesAdapter.wrap(cookies, onUpdateCookies)\n}\n\nexport type WrapperRenderOpts = RequestLifecycleOpts &\n  Partial<\n    Pick<\n      RenderOpts,\n      | 'ComponentMod'\n      | 'onUpdateCookies'\n      | 'assetPrefix'\n      | 'reactLoadableManifest'\n    >\n  > & {\n    experimental: Pick<RenderOpts['experimental'], 'after'>\n    previewProps?: __ApiPreviewProps\n  }\n\nexport type RequestContext = {\n  req: IncomingMessage | BaseNextRequest | NextRequest\n  /**\n   * The URL of the request. This only specifies the pathname and the search\n   * part of the URL. This is only undefined when generating static paths (ie,\n   * there is no request in progress, nor do we know one).\n   */\n  url: {\n    /**\n     * The pathname of the requested URL.\n     */\n    pathname: string\n\n    /**\n     * The search part of the requested URL. If the request did not provide a\n     * search part, this will be an empty string.\n     */\n    search?: string\n  }\n  res?: ServerResponse | BaseNextResponse\n  renderOpts?: WrapperRenderOpts\n}\n\nexport const withRequestStore: WithStore<RequestStore, RequestContext> = <\n  Result,\n>(\n  storage: AsyncLocalStorage<RequestStore>,\n  { req, url, res, renderOpts }: RequestContext,\n  callback: (store: RequestStore) => Result\n): Result => {\n  const [wrapWithAfter, afterContext] = createAfterWrapper(renderOpts)\n\n  function defaultOnUpdateCookies(cookies: string[]) {\n    if (res) {\n      res.setHeader('Set-Cookie', cookies)\n    }\n  }\n\n  const cache: {\n    headers?: ReadonlyHeaders\n    cookies?: ReadonlyRequestCookies\n    mutableCookies?: ResponseCookies\n    draftMode?: DraftModeProvider\n  } = {}\n\n  const store: RequestStore = {\n    // Rather than just using the whole `url` here, we pull the parts we want\n    // to ensure we don't use parts of the URL that we shouldn't. This also\n    // lets us avoid requiring an empty string for `search` in the type.\n    url: { pathname: url.pathname, search: url.search ?? '' },\n    get headers() {\n      if (!cache.headers) {\n        // Seal the headers object that'll freeze out any methods that could\n        // mutate the underlying data.\n        cache.headers = getHeaders(req.headers)\n      }\n\n      return cache.headers\n    },\n    get cookies() {\n      if (!cache.cookies) {\n        // if middleware is setting cookie(s), then include those in\n        // the initial cached cookies so they can be read in render\n        const requestCookies = new RequestCookies(\n          HeadersAdapter.from(req.headers)\n        )\n\n        if (\n          'x-middleware-set-cookie' in req.headers &&\n          typeof req.headers['x-middleware-set-cookie'] === 'string'\n        ) {\n          const setCookieValue = req.headers['x-middleware-set-cookie']\n          const responseHeaders = new Headers()\n\n          for (const cookie of splitCookiesString(setCookieValue)) {\n            responseHeaders.append('set-cookie', cookie)\n          }\n\n          const responseCookies = new ResponseCookies(responseHeaders)\n\n          // Transfer cookies from ResponseCookies to RequestCookies\n          for (const cookie of responseCookies.getAll()) {\n            requestCookies.set(cookie.name, cookie.value ?? '')\n          }\n        }\n\n        // Seal the cookies object that'll freeze out any methods that could\n        // mutate the underlying data.\n        cache.cookies = RequestCookiesAdapter.seal(requestCookies)\n      }\n\n      return cache.cookies\n    },\n    get mutableCookies() {\n      if (!cache.mutableCookies) {\n        cache.mutableCookies = getMutableCookies(\n          req.headers,\n          renderOpts?.onUpdateCookies ||\n            (res ? defaultOnUpdateCookies : undefined)\n        )\n      }\n      return cache.mutableCookies\n    },\n    get draftMode() {\n      if (!cache.draftMode) {\n        cache.draftMode = new DraftModeProvider(\n          renderOpts?.previewProps,\n          req,\n          this.cookies,\n          this.mutableCookies\n        )\n      }\n\n      return cache.draftMode\n    },\n\n    reactLoadableManifest: renderOpts?.reactLoadableManifest || {},\n    assetPrefix: renderOpts?.assetPrefix || '',\n    afterContext,\n  }\n  return wrapWithAfter(store, () => storage.run(store, callback, store))\n}\n\nfunction createAfterWrapper(\n  renderOpts: WrapperRenderOpts | undefined\n): [\n  wrap: <Result>(requestStore: RequestStore, callback: () => Result) => Result,\n  afterContext: AfterContext | undefined,\n] {\n  const isAfterEnabled = renderOpts?.experimental?.after ?? false\n  if (!renderOpts || !isAfterEnabled) {\n    return [(_, callback) => callback(), undefined]\n  }\n\n  const { waitUntil, onClose } = renderOpts\n  const cacheScope = renderOpts.ComponentMod?.createCacheScope()\n\n  const afterContext = createAfterContext({\n    waitUntil,\n    onClose,\n    cacheScope,\n  })\n\n  const wrap = <Result>(requestStore: RequestStore, callback: () => Result) =>\n    afterContext.run(requestStore, callback)\n\n  return [wrap, afterContext]\n}\n"],"names":["FLIGHT_PARAMETERS","HeadersAdapter","MutableRequestCookiesAdapter","RequestCookiesAdapter","ResponseCookies","RequestCookies","DraftModeProvider","splitCookiesString","createAfterContext","getHeaders","headers","cleaned","from","param","delete","toString","toLowerCase","seal","getMutableCookies","onUpdateCookies","cookies","wrap","withRequestStore","storage","req","url","res","renderOpts","callback","wrapWithAfter","afterContext","createAfterWrapper","defaultOnUpdateCookies","setHeader","cache","store","pathname","search","requestCookies","setCookieValue","responseHeaders","Headers","cookie","append","responseCookies","getAll","set","name","value","mutableCookies","undefined","draftMode","previewProps","reactLoadableManifest","assetPrefix","run","isAfterEnabled","experimental","after","_","waitUntil","onClose","cacheScope","ComponentMod","createCacheScope","requestStore"],"mappings":"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"}