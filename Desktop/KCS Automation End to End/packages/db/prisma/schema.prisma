generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Partner {
  id                  String   @id @default(cuid())
  name                String
  slug                String   @unique
  theme               Json?
  webhookUrl          String?
  webhookSecret       String
  emailTemplatesCfg   Json?
  payoutSplit         Decimal  @db.Decimal(5, 4)
  isActive            Boolean  @default(true)
  driveFolderId       String?
  products            Product[]
  orders              Order[]
  webhookOutbox       WebhookOutbox[]
  payouts             Payout[]
  printConfigs        PrintConfig[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model PrintConfig {
  id                  String   @id @default(cuid())
  partner             Partner? @relation(fields: [partnerId], references: [id])
  partnerId           String?
  name                String
  isDefault           Boolean  @default(false)
  readingAge          String
  fontSize            Int
  lineSpacing         Int
  fontFamily          String
  textColor           String   @default("#000000")
  textWidthPercent    Int      @default(80)
  borderPercent       Float    @default(5.0)
  maxWords            Int?
  overlayPreferences  Json?
  imageModelPreferences Json?
  iccProfilePath      String?
  bleedPercent        Float    @default(3.5)
  safeMarginMm        Float    @default(6.0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([partnerId, readingAge])
}

model Product {
  id             String   @id @default(cuid())
  partner        Partner  @relation(fields: [partnerId], references: [id])
  partnerId      String
  sku            String
  trimSize       String
  pagesMin       Int
  pagesMax       Int
  iccProfile     String
  price          Decimal  @db.Decimal(10, 2)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  orders         Order[]

  @@unique([partnerId, sku])
}

model Order {
  id                String           @id @default(cuid())
  partner           Partner          @relation(fields: [partnerId], references: [id])
  partnerId         String
  product           Product?         @relation(fields: [productId], references: [id])
  productId         String?
  status            String
  customerEmail     String
  currency          String
  totalAmount       Decimal?         @db.Decimal(10, 2)
  paymentStatus     String?          @default("pending")
  allowUserEdit     Boolean          @default(false)
  source            String
  idempotencyKey    String
  partnerOrderRef   String?
  brief             OrderBrief?
  stories           Story[]
  assets            Asset[]
  imageJobs         ImageJob[]
  layoutJobs        LayoutJob[]
  shipments         Shipment[]
  payments          Payment[]
  events            Event[]
  webhookOutbox     WebhookOutbox[]
  queueJobs         QueueJobMock[]
  imageAnalysisAudits ImageAnalysisAudit[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([partnerId, idempotencyKey])
}

model OrderBrief {
  order         Order   @relation(fields: [orderId], references: [id])
  orderId       String  @id
  raw           Json
  extractedJson Json?
  readingLevel  String?
  constraints   Json?
  imageDescriptors Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Story {
  id                 String   @id @default(cuid())
  order              Order    @relation(fields: [orderId], references: [id])
  orderId            String
  version            Int
  status             String
  outlineText        String?
  outlineJson        Json?
  emotionalProfile   Json?
  storyBrief         Json?
  draftText          String?
  finalText          String?
  tokensUsed         Int?
  validatorReport    Json?
  draftReadyAt       DateTime?
  approvalExpiresAt  DateTime?
  approvalStatus     String?  @default("auto")
  approvedAt         DateTime?
  approvalToken      String?
  assetPlan          Json?
  assetPlanVersion   Int       @default(0)
  generationState    Json?
  printStatus        String?
  printMetadata      Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  versions           StoryVersion[]
}

model StoryVersion {
  id        String   @id @default(cuid())
  story     Story    @relation(fields: [storyId], references: [id])
  storyId   String
  version   Int
  stage     String
  content   String
  metadata  Json?
  createdAt DateTime @default(now())
}

model Asset {
  id          String   @id @default(cuid())
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String
  type        String
  url         String
  meta        Json?
  provider    String?
  providerRef String?
  colorSpace  String?
  dpi         Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  imageJobs   ImageJob[] @relation("ImageJobAsset")
  layoutJobs  LayoutJob[] @relation("LayoutJobPdfAsset")
  imageAnalysisAudits ImageAnalysisAudit[]
}

model ImageAnalysisAudit {
  id        String   @id @default(cuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String
  asset     Asset?   @relation(fields: [assetId], references: [id])
  assetId   String?
  role      String
  descriptor Json
  rawResponse Json?
  faceCropMeta Json?
  provider   String
  createdAt  DateTime @default(now())
}

model ImageJob {
  id             String   @id @default(cuid())
  order          Order    @relation(fields: [orderId], references: [id])
  orderId        String
  subject        String
  prompt         String
  status         String
  outputAsset    Asset?   @relation("ImageJobAsset", fields: [outputAssetId], references: [id])
  outputAssetId  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model LayoutJob {
  id           String   @id @default(cuid())
  order        Order    @relation(fields: [orderId], references: [id])
  orderId      String
  status       String
  pdfAsset     Asset?   @relation("LayoutJobPdfAsset", fields: [pdfAssetId], references: [id])
  pdfAssetId   String?
  spec         Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Shipment {
  id              String   @id @default(cuid())
  order           Order    @relation(fields: [orderId], references: [id])
  orderId         String
  printerRef      String?
  status          String
  trackingNumber  String?
  carrier         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Payment {
  id                 String   @id @default(cuid())
  order              Order    @relation(fields: [orderId], references: [id])
  orderId            String
  stripePaymentIntent String?
  status             String
  amount             Decimal  @db.Decimal(10, 2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Payout {
  id          String   @id @default(cuid())
  partner     Partner  @relation(fields: [partnerId], references: [id])
  partnerId   String
  periodStart DateTime
  periodEnd   DateTime
  amount      Decimal  @db.Decimal(10, 2)
  status      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Event {
  id        String   @id @default(cuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String
  type      String
  payload   Json
  createdAt DateTime @default(now())
  webhookOutbox WebhookOutbox[] @relation("EventToOutbox")
}

model WebhookOutbox {
  id          String   @id @default(cuid())
  partner     Partner  @relation(fields: [partnerId], references: [id])
  partnerId   String
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String
  event       Event?   @relation("EventToOutbox", fields: [eventId], references: [id])
  eventId     String?
  target      String
  payload     Json
  signature   String?
  attempts    Int      @default(0)
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model QueueJobMock {
  id        String   @id @default(cuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String
  type      String
  payload   Json?
  createdAt DateTime @default(now())
}

