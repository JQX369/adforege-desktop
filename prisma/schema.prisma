generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  embedding Float[]  @default([])
  createdAt DateTime @default(now())
  swipes    Swipe[]
}

model Product {
  id               String             @id @default(cuid())
  title            String
  description      String
  price            Float
  images           String[]
  affiliateUrl     String
  categories       String[]
  embedding        Float[]
  status           ProductStatus      @default(PENDING)
  vendorEmail      String?
  createdAt        DateTime           @default(now())
  stripeSessionId  String?            @unique
  paidAt           DateTime?
  vendorId         String?
  affiliateProgram String?
  asin             String?
  availability     AvailabilityStatus @default(UNKNOWN)
  brand            String?
  currency         String?
  lastSeenAt       DateTime?
  merchantId       String?
  numReviews       Int?
  qualityScore     Float              @default(0)
  rating           Float?
  retailer         String?
  source           ProductSource      @default(CURATED)
  updatedAt        DateTime           @default(now()) @updatedAt
  urlCanonical     String?
  originalPrice    Float?
  discountPercent  Float?
  shippingCost     Float?
  freeShipping     Boolean            @default(false)
  deliveryDays     String?
  deliveryMin      Int?
  deliveryMax      Int?
  primeEligible    Boolean?
  inStock          Boolean            @default(true)
  stockQuantity    Int?
  imagesThumbnail  String[]
  shortDescription String?
  features         String[]
  weight           Float?
  dimensions       String?
  condition        ProductCondition   @default(NEW)
  bestSeller       Boolean            @default(false)
  sellerName       String?
  sellerRating     Float?
  sourceItemId     String?
  lastEnrichedAt   DateTime?
  popularityScore  Float              @default(0)
  recencyScore     Float              @default(0)
  expiresAt        DateTime?
  merchant         Merchant?          @relation(fields: [merchantId], references: [id])
  vendor           Vendor?            @relation(fields: [vendorId], references: [id])
  swipes           Swipe[]

  @@index([asin])
  @@index([urlCanonical])
  @@index([inStock])
  @@index([primeEligible])
  @@index([condition])
  @@index([freeShipping])
  @@index([bestSeller])
  @@index([sourceItemId])
}

model Swipe {
  id        String      @id @default(cuid())
  userId    String
  productId String
  action    SwipeAction
  ts        DateTime    @default(now())
  product   Product     @relation(fields: [productId], references: [id])
  user      User        @relation(fields: [userId], references: [id])
}

model Vendor {
  id                   String             @id @default(cuid())
  userId               String             @unique
  email                String             @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  plan                 VendorPlan         @default(BASIC)
  subscriptionStatus   SubscriptionStatus @default(INACTIVE)
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  products             Product[]
}

model Merchant {
  id               String         @id @default(cuid())
  name             String
  domain           String         @unique
  affiliateProgram String?
  status           MerchantStatus @default(ACTIVE)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  products         Product[]
}

model SessionProfile {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  embedding   Float[]  @default([])
  constraints Json?
  negatives   String[] @default([])
  seen        String[] @default([])
  region      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

model IngestionJob {
  id             String          @id @default(cuid())
  type           IngestionType
  status         IngestionStatus @default(QUEUED)
  source         String?
  startedAt      DateTime        @default(now())
  finishedAt     DateTime?
  totalProcessed Int             @default(0)
  totalInserted  Int             @default(0)
  totalUpdated   Int             @default(0)
  totalRejected  Int             @default(0)
  log            String?
}

model RecommendLog {
  id           String   @id @default(cuid())
  sessionId    String
  userId       String?
  productIds   String[]
  resultsCount Int
  createdAt    DateTime @default(now())

  @@index([sessionId])
}

model ClickEvent {
  id        String   @id @default(cuid())
  sessionId String?
  userId    String?
  productId String?
  targetUrl String
  createdAt DateTime @default(now())

  @@index([sessionId])
}

enum SwipeAction {
  LEFT
  RIGHT
  SAVED
}

enum ProductStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProductSource {
  VENDOR
  AFFILIATE
  CURATED
}

enum AvailabilityStatus {
  IN_STOCK
  OUT_OF_STOCK
  UNKNOWN
}

enum ProductCondition {
  NEW
  LIKE_NEW
  USED_VERY_GOOD
  USED_GOOD
  USED_ACCEPTABLE
  REFURBISHED
}

enum VendorPlan {
  BASIC
  FEATURED
  PREMIUM
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

enum MerchantStatus {
  ACTIVE
  INACTIVE
}

enum IngestionStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

enum IngestionType {
  CSV
  JSON
  API
}

enum ListingType {
  AUCTION
  FIXED_PRICE
  CLASSIFIED
}

enum RecommendationAction {
  IMPRESSION
  CLICK
  LIKE
  DISLIKE
  SAVE
}

model RecommendationEvent {
  id        String             @id @default(cuid())
  sessionId String?
  userId    String?
  productId String?
  action    RecommendationAction
  metadata  Json?
  createdAt DateTime           @default(now())
  
  @@map("recommendation_events")
}

model IngestionLog {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  durationMs      Int
  productsCreated Int
  productsUpdated Int
  errors          Int
  errorMessages   Json?
  
  @@map("ingestion_logs")
}
